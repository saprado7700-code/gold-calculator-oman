<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة أسعار الذهب (سوق عُمان) - تحديث مباشر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMD/CDt+VjPqV5X3GmgzNwH2S/L6Fp9i8Kk7n7eG/H2gD5b2p3Fw5O5G/7L2uG8w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* التنسيقات المُحسنة للهاتف */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFFDF7; 
            overflow-y: hidden; 
        }
        .calculator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-height: 95vh; 
            overflow-y: auto; 
            
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.08);
            background-color: #FFEF00; 
        }

        /* هذا الجزء يزيل أسهم التمرير في حقول الأرقام */
        input[type="number"] {
            -moz-appearance: textfield; 
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* التنسيقات الأخرى */
        .text-theme-dark {
            color: #585542; 
        }
        .display {
            background-color: #F4F2E7; 
            font-size: 2rem; 
            font-weight: 600;
            color: #585542; 
        }
        .input-style {
            background-color: #FFFFFF;
            color: #1f2937;
            border: 2px solid #E8E5D3;
        }
        .input-style:focus {
             --tw-ring-color: #D4AF37;
             --tw-border-opacity: 1;
             border-color: #D4AF37;
        }
    </style>
</head>
<body class="p-4"> 

    <div id="gold-calculator" class="calculator w-full max-w-xl rounded-xl p-6 md:p-8">
        <h1 class="text-3xl font-extrabold text-theme-dark mb-4 text-center">
            حاسبة أسعار الذهب (سوق عُمان)
        </h1>
        
        <p id="live-update-info" class="text-sm text-theme-dark text-center mb-6 font-medium flex items-center justify-center space-x-2 space-x-reverse">
            <i id="price-status-icon" class="fa-solid fa-circle text-gray-400 text-xs"></i>
            <span id="update-text">جاري جلب الأسعار...</span>
        </p>

        <div class="display text-right p-4 mb-6 rounded-lg h-16 flex items-center justify-end shadow-inner">
            <span id="result-span" class="w-full truncate">أدخل القيم للحساب...</span>
        </div>

        <div class="space-y-4">
            
            <label class="block text-theme-dark font-medium">
                عيار الذهب (Purity)
                <select id="goldKarat" 
                    class="w-full mt-1 p-3 rounded-lg outline-none transition duration-150 text-right input-style">
                    <option value="24">24 قيراط</option>
                    <option value="22">22 قيراط</option>
                    <option value="21">21 قيراط</option>
                    <option value="18">18 قيراط</option>
                </select>
            </label>
            
            <label class="block text-theme-dark font-medium">
                وزن الذهب (جرام)
                <input id="weight" type="number" step="0.001" value="10.000" 
                    class="w-full mt-1 p-3 rounded-lg text-right input-style" 
                    placeholder="مثال: 10.000">
            </label>
            
            <label class="block text-theme-dark font-medium mb-1">
                طريقة حساب رسوم التصنيع / أجور الصياغة
            </label>
            <div class="flex space-x-4 space-x-reverse mb-4">
                <label class="inline-flex items-center">
                    <input type="radio" name="chargesType" value="perGram" checked 
                               class="form-radio text-yellow-600 h-4 w-4" id="chargeTypePerGram">
                    <span class="mr-2 text-sm font-medium text-theme-dark">لكل جرام (ريال/جرام)</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="chargesType" value="fixed" 
                               class="form-radio text-yellow-600 h-4 w-4" id="chargeTypeFixed">
                    <span class="mr-2 text-sm font-medium text-theme-dark">مبلغ ثابت إجمالي (ريال)</span>
                </label>
            </div>

            <label class="block text-theme-dark font-medium" id="makingChargesLabel">
                قيمة رسوم التصنيع (ريال/جرام)
                <input id="makingChargesValue" type="number" step="0.001" value="3.861" 
                        class="w-full mt-1 p-3 rounded-lg text-right input-style" 
                        placeholder="مثال: 3.861">
            </label>
            <label class="block text-theme-dark font-medium">
                نسبة ضريبة القيمة المضافة (VAT)
                <select id="vatRateSelect" 
                    class="w-full mt-1 p-3 rounded-lg outline-none transition duration-150 text-right input-style">
                    <option value="0.05">5% (المعيار للمجوهرات)</option>
                    <option value="0.00">0% (الذهب الاستثماري والسبائك)</option>
                </select>
            </label>

        </div>
        
        <p class="text-xs text-theme-dark mt-4 text-center">
            *العملة هي **الريال العماني (﷼)**.
        </p>
    </div>

    <script>
        // العناصر والثوابت
        const resultSpan = document.getElementById('result-span');
        const weightInput = document.getElementById('weight');
        const goldKaratSelect = document.getElementById('goldKarat');
        const vatRateSelect = document.getElementById('vatRateSelect');
        // تم تعريفه كـ let لأنه سيتم إعادة ربطه
        let makingChargesValueInput = document.getElementById('makingChargesValue'); 
        const liveUpdateText = document.getElementById('update-text');
        const priceStatusIcon = document.getElementById('price-status-icon');
        
        // العناصر الجديدة
        const chargeTypePerGram = document.getElementById('chargeTypePerGram');
        const chargeTypeFixed = document.getElementById('chargeTypeFixed');
        const makingChargesLabel = document.getElementById('makingChargesLabel');


        const USD_PER_OMR = 2.6008; 
        const GOLD_Grams_PER_OUNCE = 31.1035; 
        
        // *تنبيه: هذا هو السعر الافتراضي الذي سيستخدمه الكود في حال فشل الاتصال بالـ API*
        let currentGoldPriceUSD_Ounce = 2350.00; 
        let lastSuccessfulGoldPriceUSD_Ounce = 2350.00; 
        
        const KARAT_PURITY = {
            '24': 1.000,
            '22': 0.9167,
            '21': 0.875,
            '18': 0.750
        };

        // دالة مساعدة لتحديث نص رسوم التصنيع وإعادة ربط الحقل
        const updateChargesLabel = () => {
            if (chargeTypePerGram.checked) {
                makingChargesLabel.innerHTML = 'قيمة رسوم التصنيع (<span class="font-bold">ريال/جرام</span>) <input id="makingChargesValue" type="number" step="0.001" value="3.861" class="w-full mt-1 p-3 rounded-lg text-right input-style" placeholder="مثال: 3.861">';
                // إعادة ربط المتغير بالعنصر بعد تحديثه
                makingChargesValueInput = document.getElementById('makingChargesValue');
            } else {
                makingChargesLabel.innerHTML = 'قيمة رسوم التصنيع (<span class="font-bold">مبلغ ثابت إجمالي ريال</span>) <input id="makingChargesValue" type="number" step="0.001" value="50.000" class="w-full mt-1 p-3 rounded-lg text-right input-style" placeholder="مثال: 50.000">';
                // إعادة ربط المتغير بالعنصر بعد تحديثه
                makingChargesValueInput = document.getElementById('makingChargesValue');
            }
            // إعادة ربط مستمعي الأحداث على حقل القيمة الجديد
            makingChargesValueInput.addEventListener('input', calculateGoldPrice);
            makingChargesValueInput.addEventListener('change', calculateGoldPrice);
        };


        // 1. تحديث التاريخ والوقت 
        const updateLiveTime = () => {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            const formattedDate = now.toLocaleDateString('ar-OM', dateOptions);
            const formattedTime = now.toLocaleTimeString('ar-OM', timeOptions);
            return `آخر تحديث: ${formattedDate} ${formattedTime}`;
        };

        // 2. دالة جلب السعر من API
        const fetchGoldPrice = async () => {
            // انتبه: لأغراض العرض، المفتاح هنا ظاهر، في تطبيق حقيقي يجب إخفاؤه
            const API_KEY = 'b7782152c6c4e316cb1eb6c45c0e54a2'; 
            const API_URL = `https://api.metalpriceapi.com/v1/latest?api_key=${API_KEY}&base=USD&currencies=XAU`; 
            
            priceStatusIcon.classList.remove('text-green-500', 'text-red-500');
            priceStatusIcon.classList.add('text-yellow-500', 'fa-spin');
            liveUpdateText.textContent = "جاري جلب الأسعار...";

            try {
                        
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`API returned status ${response.status}`);
                const data = await response.json();
                
                if (data.rates && data.rates.XAU) {
                    currentGoldPriceUSD_Ounce = 1 / data.rates.XAU; 
                    lastSuccessfulGoldPriceUSD_Ounce = currentGoldPriceUSD_Ounce;
                    
                    priceStatusIcon.classList.remove('text-yellow-500', 'fa-spin', 'text-red-500');
                    priceStatusIcon.classList.add('text-green-500');
                    liveUpdateText.textContent = `${updateLiveTime()} | الأسعار محدثة.`;
                } else {
                    throw new Error("Invalid API response format.");
                }

            } catch (error) {
                currentGoldPriceUSD_Ounce = lastSuccessfulGoldPriceUSD_Ounce; 
                
                priceStatusIcon.classList.remove('text-yellow-500', 'fa-spin', 'text-green-500');
                priceStatusIcon.classList.add('text-red-500');
                liveUpdateText.textContent = `${updateLiveTime()} | فشل الجلب (يستخدم آخر سعر ناجح).`;
                console.error("خطأ في جلب سعر الذهب المباشر (باستخدام آخر سعر ناجح):", error);
            }

            updatePriceBasedOnKarat();
        };

        // 3. دالة مساعدة لحساب سعر الجرام بالريال العماني
        const calculateOMRPerGram = (karat) => {
            const purityFactor = KARAT_PURITY[karat];
            
            const price24k_USD_Gram = currentGoldPriceUSD_Ounce / GOLD_Grams_PER_OUNCE;
            const priceKarat_USD_Gram = price24k_USD_Gram * purityFactor;
            
            return priceKarat_USD_Gram / USD_PER_OMR;
        };

        // 4. تحديث قائمة العيارات وتنفيذ الحساب
        const updatePriceBasedOnKarat = () => {
            const options = goldKaratSelect.querySelectorAll('option');
            options.forEach(option => {
                const karatValue = option.value;
                const price_omr = calculateOMRPerGram(karatValue);

                option.textContent = `${karatValue} قيراط (﷼ ${price_omr.toFixed(3)})`; 
            });

            calculateGoldPrice();
        };

        // 5. دالة تنفيذ حساب سعر الذهب
        const calculateGoldPrice = () => {
            const selectedKarat = goldKaratSelect.value;
            const pricePerGram = calculateOMRPerGram(selectedKarat) || 0; 
            
            const weight = parseFloat(weightInput.value) || 0;
            // يجب إعادة جلب القيمة في كل مرة بسبب تحديث العنصر في DOM
            const chargesValue = parseFloat(document.getElementById('makingChargesValue').value) || 0; 
            
            const isPerGram = chargeTypePerGram.checked; // تحديد طريقة الحساب
            
            const currencyUnit = 'ريال عُماني'; 
            const vatRate = parseFloat(vatRateSelect.value) || 0; 
            
            if (pricePerGram <= 0 || weight <= 0) {
                resultSpan.textContent = "جاري جلب السعر... أو أدخل وزنًا صالحًا";
                return;
            }

            try {
                let goldCost = pricePerGram * weight; // تكلفة الذهب الصافي
                let subTotal; // الإجمالي قبل الضريبة
                let makingCost; // قيمة التصنيع الكلية

                if (isPerGram) {
                    // رسوم التصنيع لكل جرام
                    makingCost = chargesValue * weight;
                    subTotal = goldCost + makingCost;

                } else {
                    // رسوم التصنيع مبلغ ثابت إجمالي
                    makingCost = chargesValue;
                    subTotal = goldCost + makingCost;
                }
                
                // حساب الضريبة والمجموع النهائي
                const vatAmount = subTotal * vatRate;
                const totalPrice = subTotal + vatAmount;

                const formattedPrice = totalPrice.toFixed(3);
                
                resultSpan.textContent = `${formattedPrice} ${currencyUnit}`;

            } catch (error) {
                resultSpan.textContent = "خطأ في الحساب";
            }
        };

        // --- ربط الأحداث والتشغيل الأولي ---
        goldKaratSelect.addEventListener('change', updatePriceBasedOnKarat);
        
        // ربط الأحداث الرئيسية
        const inputs = [weightInput, goldKaratSelect, vatRateSelect];
        inputs.forEach(element => {
            element.addEventListener('input', calculateGoldPrice);
            element.addEventListener('change', calculateGoldPrice); 
        });

        // ربط أحداث تغيير نوع الرسوم بالدالة والـ Label
        chargeTypePerGram.addEventListener('change', () => {
            updateChargesLabel();
            calculateGoldPrice();
        });
        chargeTypeFixed.addEventListener('change', () => {
            updateChargesLabel();
            calculateGoldPrice();
        });
        
        window.onload = () => {
            // تهيئة واجهة رسوم التصنيع أولاً
            updateChargesLabel(); 
            // جلب الأسعار والحساب
            fetchGoldPrice();
            // تحديث الوقت كل 15 دقيقة
            setInterval(() => {
                if(priceStatusIcon.classList.contains('text-green-500')) {
                    liveUpdateText.textContent = `${updateLiveTime()} | الأسعار محدثة.`;
                } else {
                    liveUpdateText.textContent = `${updateLiveTime()} | فشل الجلب (يستخدم آخر سعر ناجح).`;
                }
            }, 900000); 
        };
    </script>
</body>
</html>

